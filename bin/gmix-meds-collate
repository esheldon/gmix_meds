#!/usr/bin/env python
"""
    %prog [options] run tilename(s)

e.g.
    gfme004grizt DES0043-4457
    gfme004grizt DES0043-4457
"""
from __future__ import print_function
import sys
import gmix_meds

from gmix_meds.collate import ConcatError

from optparse import OptionParser
parser = OptionParser(__doc__)

parser.add_option('--noblind',action='store_true',
                  help="don't blind the catalog")
parser.add_option('--clobber',action='store_true',
                  help="clobber existing catalog, else skip over")
parser.add_option('--verify',action='store_true',
                  help="just verify every file")
parser.add_option('--cache',action='store_true',
                  help="just generate the cache")

def main():
    options, args = parser.parse_args(sys.argv[1:])
    if len(args) < 2:
        parser.print_help()
        sys.exit(45)

    run=args[0]
    tilenames=args[1:]

    if options.noblind:
        blind=False
    else:
        blind=True

    ntile=len(tilenames)
    for i,tilename in enumerate(tilenames):
        print("-"*70)
        print("%d/%d %s" % (i+1,ntile,tilename))
        print()
        try:
            tc=gmix_meds.collate.TileConcat(run, tilename,
                                            blind=blind,
                                            clobber=options.clobber)

            if options.cache:
                tc.cache_allband_se_image_ids()
                tc.cache_coadd_objects_info()
            elif options.verify:
                tc.verify()
            else:
                tc.concat()

        except ConcatError as e:
            print("\nerror found: %s" % str(e))

            if ntile > 1:
                print("continuing\n")


main()
