#!/usr/bin/env python
"""
    %prog [options] run ftype
    
e.g.
    gfme004grizt lmfit
    gfme004grizt mcmc

"""

import sys
import json
import fitsio

import desdb
import deswl
import gmix_meds

from optparse import OptionParser
parser = OptionParser(__doc__)
parser.add_option('--noblind',action='store_true',
                  help="don't blind the catalog")
parser.add_option('--clobber',action='store_true',
                  help="clobber existing catalog, else skip over")

def main():
    options, args = parser.parse_args(sys.argv[1:])
    if len(args) < 2:
        parser.print_help()
        sys.exit(45)

    run=args[0]
    ftype=args[1]

    if options.noblind:
        blind=False
    else:
        blind=True

    rc=deswl.files.Runconfig(run)
    bands=rc['band']

    info_list = desdb.files.get_coadd_info_by_release(rc['dataset'],
                                                      'i',
                                                      withbands=bands)
    print 'found',len(info_list),'tiles'
    print info_list[0]

    for fi in info_list:
        tc=gmix_meds.collate.TileConcat(run, fi['tilename'], ftype,
                                        blind=blind,
                                        clobber=options.clobber)
        tc.concat()


main()
