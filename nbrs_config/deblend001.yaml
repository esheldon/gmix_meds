# what fits to do
fitter: "ngmix"
fitter_class: "deblender"
fit_me_galaxy: True
fit_coadd_galaxy: False

############################
#flags flags flags!
############################
check_image_flags: True
# these are currently from astrometry only
# note flag bits 0-3 are already removed from the meds file
# note 2**4 is internal use
# 2**0 + 2**1 + 2**2 + 2**3 + 2**5 + 2**6 + 2**7 + 2**8 + 2**9
image_flags2check: 1007

use_psf_rerun: True
psf_rerun_version: "v3"
psfex_blacklist: "$DESDATA/EXTRA/blacklists/psfex-sv-v3.txt"
# this should combine all the flags of interest
#2**0 = 1 = No stars found
#2**1 = 2 = Too few stars found (<50)
#2**2 = 4 = Too many stars found (>500)
#2**3 = 8 = Too high FWHM (>1.8 arcsec)
#2**4 = 16 = Error encountered somewhere along the line in making the PSFEx files.
# 2**0 + 2**1 + 2**4
psf_flags2check: 19

##########################
# I/O
##########################
print_params: True
debug_level: 0

##########################
#random options
##########################
margsky: False
use_edge_aperture: False #use a circular aperture
use_guess_aper: False
aperture_nsigma: 4.0
nu: 0.0 #robust fitting usually 5

##########################
# nbrs model
##########################
nbrs_model:
    model: "best_chi2per"
    method: "subtract"
    flags: "flags"
    pars: "pars"
make_nbrs_plots: True

############################
# deblender
############################
save_obs_per_fof: True
max_deblend_itr: 10
deblend_guess_frac: 0.1
deblend_force_flags: True
deblend_iter_decide: 0
deblend_maxabs_conv: [0.001,0.001,0.001,0.001,0.001,0.001]
deblend_maxfrac_conv: [1.0e-4,1.0e-4,1.0e-2,1.0e-2,1.0e-3,1.0e-4]
deblend_maxerr_conv: 0.01
deblend_first_iter_fitter: 'lm'
deblend_rest_iter_fitter: 'lm'

####################################
# fits, models, masks and guesses
####################################

coadd_model_guess: 'coadd_psf'
me_model_guess: 'me_psf'

max_pars:
    method: 'Nelder-Mead'
    ntry: 1
    maxiter: 500
    maxfev: 500
    ftol: 1.0e-4
    xtol: 1.0e-4

lm_pars:
    ntry: 25
    ftol: 1.0e-6
    xtol: 1.0e-6
    maxfev: 2000

gal_em_pars:
    tol: 1.0e-4
    miniter: 10
    maxiter: 40    

psf_em_pars:
    ngauss: 3
    ntry: 20
    maxiter: 5000
    tol: 5.0e-6

# at least one band must have s/n > this or
# we won't fit the slow mcmc 
min_psf_s2n: 4

#region: "seg_and_sky"
region: "cweight-nearest"

# in arcsec
#psf_offset_max: 0.25

# models in addition to a psf flux
model_pars:
    exp:
        g_prior_type: "cosmos-sersic"
        T_prior_type: "TwoSidedErf"
        T_prior_pars: [-0.07, 0.03, 1.0e+06, 1.0e+05]
        counts_prior_type: "TwoSidedErf"
        counts_prior_pars: [-1.0, 0.1, 1.0e+09, 0.25e+08]
        cen_prior_type: "dgauss"
        cen_prior_pars: [0.27]
    dev:
        g_prior_type: "cosmos-sersic"
        T_prior_type: "TwoSidedErf"
        T_prior_pars: [-0.07, 0.03, 1.0e+06, 1.0e+05]
        counts_prior_type: "TwoSidedErf"
        counts_prior_pars: [-1.0, 0.1, 1.0e+09, 0.25e+08]
        cen_prior_type: "dgauss"
        cen_prior_pars: [0.27]

# this means repeat the couns priors for each band
counts_prior_repeat: True

do_shear: True

# checkpoint times in minutes, needed for condor in case we pass a batch system
# limit such as in the condor scavenge.
# 0 means after the first object

checkpoints: [0,2,4,6,8,10,12,14,16,18,20,25,30,35,40,45,50,60,70,80,90,100,120,140,160,180,200,250,300,350,400,500]


